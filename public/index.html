<!DOCTYPE html>
<html>
  <head>
    <title>GMP Autocomplete + Routes</title>
    <meta charset="utf-8" />
    <style>
      .container {
        display: flex;
        height: 100vh;
      }
      .aside {
        width: 300px;
        padding: 20px;
        background: #f5f5f5;
      }
      .main {
        flex: 1;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      .inputgroup {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        width: 100%;
        padding: 12px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #3367d6;
      }
      /* Hide close button on InfoWindow */
      .gm-style-iw-c button[aria-label="Close"] {
        display: none !important;
      }
      .gm-style-iw button[aria-label="Close"] {
        display: none !important;
      }
      .gm-ui-hover-effect {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="aside">
        <div class="inputgroup">
          <label for="origin">Start</label>
          <input
            type="text"
            id="origin"
            class="input-location"
            placeholder="Enter start address"
          />
        </div>
        <div class="inputgroup">
          <label for="destination">End</label>
          <input
            type="text"
            id="destination"
            class="input-location"
            placeholder="Enter end address"
          />
        </div>
        <input type="hidden" id="origin-place-id" />
        <input type="hidden" id="destination-place-id" />
        <div class="inputgroup">
          <button id="btn-getroute">Get Routes</button>
        </div>
        <div class="inputgroup">
          <button id="btn-updatedata">Update Data</button>
        </div>
      </div>
      <div class="main">
        <div id="map"></div>
      </div>
    </div>

    <!-- ‚úÖ EVERYTHING INLINE - NO EXTERNAL app.js NEEDED -->
    <script>
      let map,
        routeWithStopoverPolyline,
        routeWithoutStopoverPolyline,
        priceLabel,
        hardcodedPriceLabel;

      // ‚úÖ GLOBAL initMap - Called by Google Maps
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 49.25306110580261, lng: -123.18205396352421 },
          zoom: 8,
          mapId: "DEMO_MAP_ID",
        });

        // Origin autocomplete
        const originInput = document.getElementById("origin");
        const autocompleteOrigin = new google.maps.places.Autocomplete(
          originInput,
          {
            fields: ["place_id"],
          }
        );
        autocompleteOrigin.addListener("place_changed", () => {
          const place = autocompleteOrigin.getPlace();
          if (place.place_id) {
            document.getElementById("origin-place-id").value = place.place_id;
            console.log("‚úÖ Origin:", place.place_id);
          }
        });

        // Destination autocomplete
        const destInput = document.getElementById("destination");
        const autocompleteDest = new google.maps.places.Autocomplete(
          destInput,
          {
            fields: ["place_id"],
          }
        );
        autocompleteDest.addListener("place_changed", () => {
          const place = autocompleteDest.getPlace();
          if (place.place_id) {
            document.getElementById("destination-place-id").value =
              place.place_id;
            console.log("‚úÖ Destination:", place.place_id);
          }
        });

        // Button
        document
          .getElementById("btn-getroute")
          .addEventListener("click", requestRoutes);
        document
          .getElementById("btn-updatedata")
          .addEventListener("click", updateData);
        console.log("‚úÖ READY - Type addresses & click Get Routes");
      }

      // ‚úÖ requestRoutes - Called by button
      async function requestRoutes() {
        console.log("üîç Requesting routes...");

        const originPlaceId = document.getElementById("origin-place-id").value;
        const destPlaceId = document.getElementById(
          "destination-place-id"
        ).value;

        if (!originPlaceId || !destPlaceId) {
          alert("Please select addresses from dropdowns");
          return;
        }

        clearMap();

        try {
          const response = await fetch("/request-routes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              origin: { placeId: originPlaceId },
              destination: { placeId: destPlaceId },
            }),
          });

          const data = await response.json();
          console.log("üì¶ FULL RESPONSE:", data);
          console.log("üéØ Use Stopover:", data.useStopover);

          // Always show gas station marker and price
          if (data.stopoverLocation?.latLng?.latitude) {
            const markerPosition = {
              lat: data.stopoverLocation.latLng.latitude,
              lng: data.stopoverLocation.latLng.longitude,
            };

            new google.maps.Marker({
              position: markerPosition,
              map: map,
              title: "Gas Station",
              icon: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
            });

            // Add gas price label above the marker
            if (data.gasPrice) {
              priceLabel = new google.maps.InfoWindow({
                content: `<div style="background: white; color: black; padding: 5px 10px; font-weight: bold; border: 1px solid #ccc; border-radius: 4px;">${data.gasPrice.toFixed(
                  1
                )}¬¢</div>`,
                position: markerPosition,
                disableAutoPan: true,
                disableCloseButton: true,
              });
              priceLabel.open(map);
            }
          }

          // Display route based on useStopover flag
          if (data.useStopover) {
            // Show stopover route (Red)
            if (
              data.routeWithStopover?.routes?.[0]?.polyline?.encodedPolyline
            ) {
              const path = google.maps.geometry.encoding.decodePath(
                data.routeWithStopover.routes[0].polyline.encodedPolyline
              );
              routeWithStopoverPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 6,
                map: map,
              });
              console.log("‚úÖ RED stopover route drawn (cheaper option)");
            }
          } else {
            // Show direct route (Blue)
            if (
              data.routeWithoutStopover?.routes?.[0]?.polyline?.encodedPolyline
            ) {
              const path = google.maps.geometry.encoding.decodePath(
                data.routeWithoutStopover.routes[0].polyline.encodedPolyline
              );
              routeWithoutStopoverPolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: "#0000FF",
                strokeOpacity: 0.8,
                strokeWeight: 5,
                map: map,
              });
              console.log("‚úÖ BLUE direct route drawn (cheaper option)");
            }
          }

          // Always show hardcoded gas station marker with price
          const hardcodedGasStation = {
            lat: 49.263542430132006,
            lng: -123.20347273542006,
            price: 155.9,
          };

          new google.maps.Marker({
            position: {
              lat: hardcodedGasStation.lat,
              lng: hardcodedGasStation.lng,
            },
            map: map,
            title: "Gas Station (Hardcoded)",
            icon: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
          });

          // Add gas price label above the hardcoded marker
          hardcodedPriceLabel = new google.maps.InfoWindow({
            content: `<div style="background: white; color: black; padding: 5px 10px; font-weight: bold; border: 1px solid #ccc; border-radius: 4px;">${hardcodedGasStation.price.toFixed(
              1
            )}¬¢</div>`,
            position: {
              lat: hardcodedGasStation.lat,
              lng: hardcodedGasStation.lng,
            },
            disableAutoPan: true,
            disableCloseButton: true,
          });
          hardcodedPriceLabel.open(map);
        } catch (error) {
          console.error("üí• Error:", error);
          alert("Backend error - check console");
        }
      }

      function clearMap() {
        if (routeWithStopoverPolyline) {
          routeWithStopoverPolyline.setMap(null);
          routeWithStopoverPolyline = null;
        }
        if (routeWithoutStopoverPolyline) {
          routeWithoutStopoverPolyline.setMap(null);
          routeWithoutStopoverPolyline = null;
        }
        if (priceLabel) {
          priceLabel.close();
          priceLabel = null;
        }
        if (hardcodedPriceLabel) {
          hardcodedPriceLabel.close();
          hardcodedPriceLabel = null;
        }
      }

      // ‚úÖ updateData - Capture and scan via Python, then update prices
      async function updateData() {
        console.log("üì∏ Capturing and scanning...");

        try {
          const response = await fetch("/update-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          const data = await response.json();
          console.log("üì¶ Scan response:", data);

          if (data.success) {
            alert(
              `Scanned number: ${
                data.number
              } (confidence: ${data.confidence.toFixed(2)})`
            );
            console.log("‚úÖ Price updated successfully");
          } else {
            alert(`Scan failed: ${data.message || data.error}`);
          }
        } catch (error) {
          console.error("üí• Error:", error);
          alert("Error updating data - check console");
        }
      }
    </script>

    <!-- ‚úÖ Google Maps LAST - Calls initMap -->
    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAeCfwA9OHLveBZB2p3Z-9sHMV3wS1eZDo&libraries=places,geometry&callback=initMap"
    ></script>
  </body>
</html>
